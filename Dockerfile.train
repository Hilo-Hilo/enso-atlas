# Dockerfile for MedGemma embedding/training
# Based on DeepSeek OCR approach for stable PyTorch on DGX Spark (ARM64 Blackwell)
#
# Build: docker build -f Dockerfile.train -t medgemma-train .
# Run:   docker run --gpus all --ipc=host -v $(pwd)/data:/app/data medgemma-train <command>

FROM nvcr.io/nvidia/pytorch:25.12-py3

ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# CUDA environment
ENV CUDA_HOME=/usr/local/cuda
ENV LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH
ENV PATH=/usr/local/cuda/bin:$PATH

# Verify base image PyTorch
RUN python -c "import torch; print(f'PyTorch: {torch.__version__} (CUDA: {torch.version.cuda})')"

# Install system dependencies for OpenSlide
RUN apt-get update && apt-get install -y \
    openslide-tools \
    libopenslide0 \
    libopenslide-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy requirements and install (excluding torch since base has it)
COPY requirements.txt /app/
RUN grep -v "^torch" requirements.txt | pip install --no-cache-dir -r /dev/stdin

# Skip flash-attn for stability (ABI issues with container PyTorch)
RUN pip uninstall -y flash-attn || true

# Copy application code
COPY src/ /app/src/
COPY scripts/ /app/scripts/
COPY config/ /app/config/

# Create directories
RUN mkdir -p /app/data /app/models /app/outputs

ENV PYTHONPATH=/app/src
ENV HF_HOME=/app/cache/huggingface
ENV TRANSFORMERS_CACHE=/app/cache/huggingface

WORKDIR /app
