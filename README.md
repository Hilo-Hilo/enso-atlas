# Enso Atlas

**On-Prem Pathology Evidence Engine for Treatment-Response Insight**

Enso Atlas is an on-premise pathology evidence engine that analyzes whole-slide images (WSIs) to predict treatment response and provides interpretable, auditable evidence for clinical decision support.

---

## Table of Contents

1. [Overview](#overview)
2. [Key Features](#key-features)
3. [Architecture](#architecture)
4. [Quick Start](#quick-start)
5. [API Endpoints](#api-endpoints)
6. [Frontend](#frontend)
7. [Project Structure](#project-structure)
8. [Configuration](#configuration)
9. [Development](#development)
10. [License](#license)

---

## Overview

Enso Atlas takes whole-slide images (WSIs) and produces:

- **Patient/slide-level prediction score** for treatment response (e.g., bevacizumab response)
- **Evidence heatmap** highlighting regions most responsible for the prediction
- **Similarity search** showing the most similar patches/cases from a reference cohort
- **Structured tumor board summary** generated by MedGemma

### Design Principles

- **Local-first**: Runs entirely on-premise; no PHI leaves the hospital network
- **Evidence-based**: Heatmaps + patch retrieval + structured reports provide auditable evidence
- **Foundation-model agnostic**: Swap embedding models without changing the product architecture
- **Efficient**: Embed patches once, reuse for multiple downstream tasks

---

## Key Features

| Feature | Description |
|---------|-------------|
| WSI Processing | OpenSlide-based processing with tissue detection and patch sampling |
| Path Foundation Embeddings | 384-dim embeddings from Google's Path Foundation model |
| CLAM MIL Classification | Attention-based multiple instance learning for slide-level prediction |
| Evidence Heatmaps | Attention weight visualization overlaid on slide thumbnails |
| FAISS Similarity Search | Find similar patches/cases from reference cohort |
| MedGemma Reporting | Structured JSON reports with safety guardrails |
| Professional Frontend | Next.js 14 app with OpenSeadragon WSI viewer |

---

## Architecture

```
                           Enso Atlas Architecture
    
    +------------------+     +------------------+     +------------------+
    |   WSI Input      |     |   FastAPI        |     |   Next.js        |
    |   (.svs, .ndpi)  |---->|   Backend        |<----|   Frontend       |
    +------------------+     +------------------+     +------------------+
                                    |
           +------------------------+------------------------+
           |                        |                        |
           v                        v                        v
    +-------------+          +-------------+          +-------------+
    |   Path      |          |   CLAM      |          |   FAISS     |
    |   Foundation|          |   MIL Head  |          |   Index     |
    |   Embedder  |          |             |          |             |
    +-------------+          +-------------+          +-------------+
           |                        |                        |
           +------------------------+------------------------+
                                    |
                                    v
                          +------------------+
                          |   MedGemma       |
                          |   Reporter       |
                          +------------------+
                                    |
                                    v
                          +------------------+
                          |   Structured     |
                          |   Report + JSON  |
                          +------------------+
```

### Tech Stack

| Component | Technology |
|-----------|------------|
| WSI I/O | OpenSlide |
| Embeddings | Path Foundation (384-dim ViT-S) |
| MIL Head | CLAM (Gated Attention) |
| Retrieval | FAISS |
| Reporting | MedGemma 1.5 4B |
| Backend | FastAPI + Python 3.10+ |
| Frontend | Next.js 14 + TypeScript + Tailwind CSS |
| Viewer | OpenSeadragon |
| Deployment | Docker + NVIDIA Container Toolkit |

---

## Quick Start

### Prerequisites

- Python 3.10+
- Node.js 18+ (for frontend)
- NVIDIA GPU with CUDA support (recommended)
- OpenSlide library installed

### Backend Setup

```bash
# Clone the repository
git clone https://github.com/Hilo-Hilo/med-gemma-hackathon.git
cd med-gemma-hackathon

# Create virtual environment
python -m venv .venv
source .venv/bin/activate

# Install dependencies
pip install -e .

# Start the API server
python -m enso_atlas.api.main
# Server runs at http://localhost:8000
```

### Frontend Setup

```bash
# Navigate to frontend directory
cd frontend

# Install dependencies
npm install

# Start development server
npm run dev
# Frontend runs at http://localhost:3000
```

### Using the Gradio Demo

```bash
# Run the Gradio demo interface
python -m enso_atlas.ui.demo_app
# Demo runs at http://localhost:7860
```

### Docker Deployment

```bash
# Build and run with Docker Compose
docker-compose up -d

# Access:
# - API: http://localhost:8000
# - Frontend: http://localhost:3000
```

---

## API Endpoints

### Health and Status

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/health` | Health check with model status |
| GET | `/` | API root with version info |
| GET | `/api/docs` | Swagger UI documentation |
| GET | `/api/redoc` | ReDoc documentation |

### Slide Operations

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/slides` | List all available slides with metadata |
| POST | `/api/analyze` | Analyze a slide and return prediction with evidence |
| GET | `/api/heatmap/{slide_id}` | Get attention heatmap as PNG image |

### Report Generation

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/report` | Generate structured MedGemma report |

### Embedding and Similarity

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/embed` | Generate embeddings for patch images |
| GET | `/api/embed/status` | Check Path Foundation embedder status |
| GET | `/api/similar` | Find similar cases from reference cohort |

### Request/Response Examples

**Analyze Slide:**
```bash
curl -X POST http://localhost:8000/api/analyze \
  -H "Content-Type: application/json" \
  -d '{"slide_id": "slide_001"}'
```

**Generate Report:**
```bash
curl -X POST http://localhost:8000/api/report \
  -H "Content-Type: application/json" \
  -d '{"slide_id": "slide_001", "include_evidence": true}'
```

---

## Frontend

The frontend is a Next.js 14 application with TypeScript, providing a professional interface for pathologists and oncologists.

### Key Components

| Component | Location | Description |
|-----------|----------|-------------|
| WSIViewer | `frontend/src/components/viewer/` | OpenSeadragon-based slide viewer with heatmap overlay |
| SlideSelector | `frontend/src/components/panels/` | Slide selection and analysis trigger |
| PredictionPanel | `frontend/src/components/panels/` | Display prediction score and confidence |
| EvidencePanel | `frontend/src/components/panels/` | Evidence patch gallery with attention weights |
| SimilarCasesPanel | `frontend/src/components/panels/` | Similar cases from reference cohort |
| ReportPanel | `frontend/src/components/panels/` | MedGemma report display and export |

### Frontend Architecture

```
frontend/
|-- src/
|   |-- app/
|   |   |-- layout.tsx          # Root layout
|   |   |-- page.tsx            # Main application page
|   |-- components/
|   |   |-- layout/             # Header, Footer
|   |   |-- panels/             # Analysis result panels
|   |   |-- ui/                 # Reusable UI components
|   |   |-- viewer/             # WSI viewer with OpenSeadragon
|   |-- hooks/
|   |   |-- useAnalysis.ts      # Analysis state management
|   |   |-- useViewer.ts        # OpenSeadragon integration
|   |-- lib/
|   |   |-- api.ts              # Backend API client
|   |   |-- utils.ts            # Utility functions
|   |-- types/
|       |-- index.ts            # TypeScript type definitions
```

---

## Project Structure

```
med-gemma-hackathon/
|-- src/
|   |-- enso_atlas/
|   |   |-- api/
|   |   |   |-- main.py         # FastAPI application and endpoints
|   |   |   |-- state.py        # Application state management
|   |   |-- embedding/
|   |   |   |-- embedder.py     # Path Foundation embedder
|   |   |-- evidence/
|   |   |   |-- generator.py    # Heatmaps and FAISS retrieval
|   |   |-- mil/
|   |   |   |-- clam.py         # CLAM attention MIL classifier
|   |   |-- reporting/
|   |   |   |-- medgemma.py     # MedGemma report generation
|   |   |-- ui/
|   |   |   |-- app.py          # Gradio interface (basic)
|   |   |   |-- demo_app.py     # Gradio demo interface
|   |   |-- wsi/
|   |   |   |-- processor.py    # WSI processing and tiling
|   |   |-- config.py           # Configuration dataclasses
|   |   |-- core.py             # Core EnsoAtlas class
|   |   |-- cli.py              # Command-line interface
|-- frontend/                   # Next.js frontend application
|-- config/                     # YAML configuration files
|-- data/
|   |-- demo/
|       |-- embeddings/         # Pre-computed embeddings
|-- docker/                     # Docker configuration
|-- docs/                       # Documentation
|-- models/                     # Trained model weights
|-- scripts/                    # Utility scripts
|-- tests/                      # Unit tests
|-- plan.md                     # Product requirements document
|-- technical_specification.md  # Technical specification
|-- pyproject.toml              # Python package configuration
|-- requirements.txt            # Python dependencies
```

---

## Configuration

### Backend Configuration

Configuration is managed via dataclasses in `src/enso_atlas/config.py`:

```python
# MIL Configuration
MILConfig(
    input_dim=384,          # Path Foundation embedding dimension
    hidden_dim=128,         # Hidden layer size
    attention_heads=1,      # Number of attention heads
    dropout=0.25,           # Dropout rate
    learning_rate=1e-4,     # Training learning rate
)

# Embedding Configuration
EmbeddingConfig(
    model="google/path-foundation",
    batch_size=32,
    device="cuda",          # or "cpu", "mps"
)

# Reporting Configuration
ReportingConfig(
    model="/app/models/medgemma-4b-it",
    max_evidence_patches=8,
    max_output_tokens=1024,
    temperature=0.3,
)
```

### Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `CUDA_VISIBLE_DEVICES` | GPU device selection | All GPUs |
| `ENSO_ATLAS_PORT` | API server port | 8000 |
| `NEXT_PUBLIC_API_URL` | Frontend API base URL | http://localhost:8000 |

---

## Development

### Running Tests

```bash
# Run all tests
pytest tests/

# Run with coverage
pytest --cov=src tests/
```

### Code Quality

```bash
# Linting
ruff check src/

# Type checking
mypy src/
```

### Building Documentation

```bash
# Generate API documentation
pdoc --html src/enso_atlas -o docs/api/
```

---

## Dataset

The prototype uses the **Ovarian Bevacizumab Response Dataset** from Nature Scientific Data:

> 288 de-identified H&E WSIs from 78 patients with response labels

Reference: [Nature Scientific Data](https://www.nature.com/articles/s41597-022-01127-6)

---

## License

MIT License - See [LICENSE](LICENSE)

---

## Acknowledgments

- Google Health AI for Path Foundation and MedGemma
- NVIDIA for DGX Spark hardware
- The authors of the Ovarian Bevacizumab Response Dataset

---

## References

1. Lu et al., "Data-efficient and weakly supervised computational pathology on whole-slide images," Nature Biomedical Engineering, 2021.
2. Google Health AI, "Path Foundation Model," https://developers.google.com/health-ai-developer-foundations/path-foundation
3. Google, "MedGemma," https://developers.google.com/health-ai-developer-foundations/medgemma
